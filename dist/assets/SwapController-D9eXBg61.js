import{N as l,K as G,g as O,R as A,S as g,L as D,M as P,E as B,P as M,W as F,i as w,r as v,j as L,Q as N,U as z,V as R,n as x,o as V,X as H,v as Q,w as $}from"./index-DgfMQxqM.js";const I={getGasPriceInEther(n,t){const o=t*n;return Number(o)/1e18},getGasPriceInUSD(n,t,o){const s=I.getGasPriceInEther(t,o);return l.bigNumber(n).times(s).toNumber()},getPriceImpact({sourceTokenAmount:n,sourceTokenPriceInUSD:t,toTokenPriceInUSD:o,toTokenAmount:s}){const r=l.bigNumber(n).times(t),i=l.bigNumber(s).times(o);return r.minus(i).div(r).times(100).toNumber()},getMaxSlippage(n,t){const o=l.bigNumber(n).div(100);return l.multiply(t,o).toNumber()},getProviderFee(n,t=.0085){return l.bigNumber(n).times(t).toString()},isInsufficientNetworkTokenForGas(n,t){const o=t||"0";return l.bigNumber(n).eq(0)?!0:l.bigNumber(l.bigNumber(o)).gt(n)},isInsufficientSourceTokenForSwap(n,t,o){var i,u;const s=(u=(i=o==null?void 0:o.find(d=>d.address===t))==null?void 0:i.quantity)==null?void 0:u.numeric;return l.bigNumber(s||"0").lt(n)}},_=15e4,q=6,k={initializing:!1,initialized:!1,loadingPrices:!1,loadingQuote:!1,loadingApprovalTransaction:!1,loadingBuildTransaction:!1,loadingTransaction:!1,switchingTokens:!1,fetchError:!1,approvalTransaction:void 0,swapTransaction:void 0,transactionError:void 0,sourceToken:void 0,sourceTokenAmount:"",sourceTokenPriceInUSD:0,toToken:void 0,toTokenAmount:"",toTokenPriceInUSD:0,networkPrice:"0",networkBalanceInUSD:"0",networkTokenSymbol:"",inputError:void 0,slippage:x.CONVERT_SLIPPAGE_TOLERANCE,tokens:void 0,popularTokens:void 0,suggestedTokens:void 0,foundTokens:void 0,myTokensWithBalance:void 0,tokensPriceMap:{},gasFee:"0",gasPriceInUSD:0,priceImpact:void 0,maxSlippage:void 0,providerFee:void 0},e=O({...k}),E={state:e,subscribe(n){return $(e,()=>n(e))},subscribeKey(n,t){return Q(e,n,t)},getParams(){var c,T,p,f,S,h,y,b,C;const n=w.state.activeChain,t=((c=w.getAccountData(n))==null?void 0:c.caipAddress)??w.state.activeCaipAddress,o=L.getPlainAddress(t),s=V(),r=H.getConnectorId(w.state.activeChain);if(!o)throw new Error("No address found to swap the tokens from.");const i=!((T=e.toToken)!=null&&T.address)||!((p=e.toToken)!=null&&p.decimals),u=!((f=e.sourceToken)!=null&&f.address)||!((S=e.sourceToken)!=null&&S.decimals)||!l.bigNumber(e.sourceTokenAmount).gt(0),d=!e.sourceTokenAmount;return{networkAddress:s,fromAddress:o,fromCaipAddress:t,sourceTokenAddress:(h=e.sourceToken)==null?void 0:h.address,toTokenAddress:(y=e.toToken)==null?void 0:y.address,toTokenAmount:e.toTokenAmount,toTokenDecimals:(b=e.toToken)==null?void 0:b.decimals,sourceTokenAmount:e.sourceTokenAmount,sourceTokenDecimals:(C=e.sourceToken)==null?void 0:C.decimals,invalidToToken:i,invalidSourceToken:u,invalidSourceTokenAmount:d,availableToSwap:t&&!i&&!u&&!d,isAuthConnector:r===P.CONNECTOR_ID.AUTH}},async setSourceToken(n){if(!n){e.sourceToken=n,e.sourceTokenAmount="",e.sourceTokenPriceInUSD=0;return}e.sourceToken=n,await a.setTokenPrice(n.address,"sourceToken")},setSourceTokenAmount(n){e.sourceTokenAmount=n},async setToToken(n){if(!n){e.toToken=n,e.toTokenAmount="",e.toTokenPriceInUSD=0;return}e.toToken=n,await a.setTokenPrice(n.address,"toToken")},setToTokenAmount(n){e.toTokenAmount=n?l.toFixed(n,q):""},async setTokenPrice(n,t){let o=e.tokensPriceMap[n]||0;o||(e.loadingPrices=!0,o=await a.getAddressPrice(n)),t==="sourceToken"?e.sourceTokenPriceInUSD=o:t==="toToken"&&(e.toTokenPriceInUSD=o),e.loadingPrices&&(e.loadingPrices=!1),a.getParams().availableToSwap&&!e.switchingTokens&&a.swapTokens()},async switchTokens(){if(!(e.initializing||!e.initialized||e.switchingTokens)){e.switchingTokens=!0;try{const n=e.toToken?{...e.toToken}:void 0,t=e.sourceToken?{...e.sourceToken}:void 0,o=n&&e.toTokenAmount===""?"1":e.toTokenAmount;a.setSourceTokenAmount(o),a.setToTokenAmount(""),await a.setSourceToken(n),await a.setToToken(t),e.switchingTokens=!1,a.swapTokens()}catch(n){throw e.switchingTokens=!1,n}}},resetState(){e.myTokensWithBalance=k.myTokensWithBalance,e.tokensPriceMap=k.tokensPriceMap,e.initialized=k.initialized,e.initializing=k.initializing,e.switchingTokens=k.switchingTokens,e.sourceToken=k.sourceToken,e.sourceTokenAmount=k.sourceTokenAmount,e.sourceTokenPriceInUSD=k.sourceTokenPriceInUSD,e.toToken=k.toToken,e.toTokenAmount=k.toTokenAmount,e.toTokenPriceInUSD=k.toTokenPriceInUSD,e.networkPrice=k.networkPrice,e.networkTokenSymbol=k.networkTokenSymbol,e.networkBalanceInUSD=k.networkBalanceInUSD,e.inputError=k.inputError},resetValues(){var o;const{networkAddress:n}=a.getParams(),t=(o=e.tokens)==null?void 0:o.find(s=>s.address===n);a.setSourceToken(t),a.setToToken(void 0)},getApprovalLoadingState(){return e.loadingApprovalTransaction},clearError(){e.transactionError=void 0},async initializeState(){if(!e.initializing){if(e.initializing=!0,!e.initialized)try{await a.fetchTokens(),e.initialized=!0}catch{e.initialized=!1,g.showError("Failed to initialize swap"),A.goBack()}e.initializing=!1}},async fetchTokens(){var o;const{networkAddress:n}=a.getParams();await a.getNetworkTokenPrice(),await a.getMyTokensWithBalance();const t=(o=e.myTokensWithBalance)==null?void 0:o.find(s=>s.address===n);t&&(e.networkTokenSymbol=t.symbol,a.setSourceToken(t),a.setSourceTokenAmount("0"))},async getTokenList(){var t;const n=(t=w.state.activeCaipNetwork)==null?void 0:t.caipNetworkId;if(!(e.caipNetworkId===n&&e.tokens))try{e.tokensLoading=!0;const o=await N.getTokenList(n);e.tokens=o,e.caipNetworkId=n,e.popularTokens=o.sort((s,r)=>s.symbol<r.symbol?-1:s.symbol>r.symbol?1:0),e.suggestedTokens=o.filter(s=>!!x.SWAP_SUGGESTED_TOKENS.includes(s.symbol))}catch{e.tokens=[],e.popularTokens=[],e.suggestedTokens=[]}finally{e.tokensLoading=!1}},async getAddressPrice(n){var c,T;const t=e.tokensPriceMap[n];if(t)return t;const o=await v.fetchTokenPrice({addresses:[n]}),s=(o==null?void 0:o.fungibles)||[],r=[...e.tokens||[],...e.myTokensWithBalance||[]],i=(c=r==null?void 0:r.find(p=>p.address===n))==null?void 0:c.symbol,u=((T=s.find(p=>p.symbol.toLowerCase()===(i==null?void 0:i.toLowerCase())))==null?void 0:T.price)||0,d=parseFloat(u.toString());return e.tokensPriceMap[n]=d,d},async getNetworkTokenPrice(){var r;const{networkAddress:n}=a.getParams(),o=(r=(await v.fetchTokenPrice({addresses:[n]}).catch(()=>(g.showError("Failed to fetch network token price"),{fungibles:[]}))).fungibles)==null?void 0:r[0],s=(o==null?void 0:o.price.toString())||"0";e.tokensPriceMap[n]=parseFloat(s),e.networkTokenSymbol=(o==null?void 0:o.symbol)||"",e.networkPrice=s},async getMyTokensWithBalance(n){const t=await R.getMyTokensWithBalance(n),o=N.mapBalancesToSwapTokens(t);o&&(await a.getInitialGasPrice(),a.setBalances(o))},setBalances(n){const{networkAddress:t}=a.getParams(),o=w.state.activeCaipNetwork;if(!o)return;const s=n.find(r=>r.address===t);n.forEach(r=>{e.tokensPriceMap[r.address]=r.price||0}),e.myTokensWithBalance=n.filter(r=>r.address.startsWith(o.caipNetworkId)),e.networkBalanceInUSD=s?l.multiply(s.quantity.numeric,s.price).toString():"0"},async getInitialGasPrice(){var t,o;const n=await N.fetchGasPrice();if(!n)return{gasPrice:null,gasPriceInUSD:null};switch((o=(t=w.state)==null?void 0:t.activeCaipNetwork)==null?void 0:o.chainNamespace){case P.CHAIN.SOLANA:return e.gasFee=n.standard??"0",e.gasPriceInUSD=l.multiply(n.standard,e.networkPrice).div(1e9).toNumber(),{gasPrice:BigInt(e.gasFee),gasPriceInUSD:Number(e.gasPriceInUSD)};case P.CHAIN.EVM:default:const s=n.standard??"0",r=BigInt(s),i=BigInt(_),u=I.getGasPriceInUSD(e.networkPrice,i,r);return e.gasFee=s,e.gasPriceInUSD=u,{gasPrice:r,gasPriceInUSD:u}}},async swapTokens(){var i,u,d;const n=(i=w.getAccountData())==null?void 0:i.address,t=e.sourceToken,o=e.toToken,s=l.bigNumber(e.sourceTokenAmount).gt(0);if(s||a.setToTokenAmount(""),!o||!t||e.loadingPrices||!s||!n)return;e.loadingQuote=!0;const r=l.bigNumber(e.sourceTokenAmount).times(10**t.decimals).round(0);try{const c=await v.fetchSwapQuote({userAddress:n,from:t.address,to:o.address,gasPrice:e.gasFee,amount:r.toString()});e.loadingQuote=!1;const T=(d=(u=c==null?void 0:c.quotes)==null?void 0:u[0])==null?void 0:d.toAmount;if(!T){z.open({displayMessage:"Incorrect amount",debugMessage:"Please enter a valid amount"},"error");return}const p=l.bigNumber(T).div(10**o.decimals).toString();a.setToTokenAmount(p),a.hasInsufficientToken(e.sourceTokenAmount,t.address)?e.inputError="Insufficient balance":(e.inputError=void 0,a.setTransactionDetails())}catch(c){const T=await N.handleSwapError(c);e.loadingQuote=!1,e.inputError=T||"Insufficient balance"}},async getTransaction(){const{fromCaipAddress:n,availableToSwap:t}=a.getParams(),o=e.sourceToken,s=e.toToken;if(!(!n||!t||!o||!s||e.loadingQuote))try{e.loadingBuildTransaction=!0;const r=await N.fetchSwapAllowance({userAddress:n,tokenAddress:o.address,sourceTokenAmount:e.sourceTokenAmount,sourceTokenDecimals:o.decimals});let i;return r?i=await a.createSwapTransaction():i=await a.createAllowanceTransaction(),e.loadingBuildTransaction=!1,e.fetchError=!1,i}catch{A.goBack(),g.showError("Failed to check allowance"),e.loadingBuildTransaction=!1,e.approvalTransaction=void 0,e.swapTransaction=void 0,e.fetchError=!0;return}},async createAllowanceTransaction(){const{fromCaipAddress:n,sourceTokenAddress:t,toTokenAddress:o}=a.getParams();if(!(!n||!o)){if(!t)throw new Error("createAllowanceTransaction - No source token address found.");try{const s=await v.generateApproveCalldata({from:t,to:o,userAddress:n}),r=L.getPlainAddress(s.tx.from);if(!r)throw new Error("SwapController:createAllowanceTransaction - address is required");const i={data:s.tx.data,to:r,gasPrice:BigInt(s.tx.eip155.gasPrice),value:BigInt(s.tx.value),toAmount:e.toTokenAmount};return e.swapTransaction=void 0,e.approvalTransaction={data:i.data,to:i.to,gasPrice:i.gasPrice,value:i.value,toAmount:i.toAmount},{data:i.data,to:i.to,gasPrice:i.gasPrice,value:i.value,toAmount:i.toAmount}}catch{A.goBack(),g.showError("Failed to create approval transaction"),e.approvalTransaction=void 0,e.swapTransaction=void 0,e.fetchError=!0;return}}},async createSwapTransaction(){var u;const{networkAddress:n,fromCaipAddress:t,sourceTokenAmount:o}=a.getParams(),s=e.sourceToken,r=e.toToken;if(!t||!o||!s||!r)return;const i=(u=D.parseUnits(o,s.decimals))==null?void 0:u.toString();try{const d=await v.generateSwapCalldata({userAddress:t,from:s.address,to:r.address,amount:i,disableEstimate:!0}),c=s.address===n,T=BigInt(d.tx.eip155.gas),p=BigInt(d.tx.eip155.gasPrice),f=L.getPlainAddress(d.tx.to);if(!f)throw new Error("SwapController:createSwapTransaction - address is required");const S={data:d.tx.data,to:f,gas:T,gasPrice:p,value:BigInt(c?i??"0":"0"),toAmount:e.toTokenAmount};return e.gasPriceInUSD=I.getGasPriceInUSD(e.networkPrice,T,p),e.approvalTransaction=void 0,e.swapTransaction=S,S}catch{A.goBack(),g.showError("Failed to create transaction"),e.approvalTransaction=void 0,e.swapTransaction=void 0,e.fetchError=!0;return}},onEmbeddedWalletApprovalSuccess(){g.showLoading("Approve limit increase in your wallet"),A.replace("SwapPreview")},async sendTransactionForApproval(n){var r,i,u;const{fromAddress:t,isAuthConnector:o}=a.getParams();e.loadingApprovalTransaction=!0,o?A.pushTransactionStack({onSuccess:a.onEmbeddedWalletApprovalSuccess}):g.showLoading("Approve limit increase in your wallet");try{await D.sendTransaction({address:t,to:n.to,data:n.data,value:n.value,chainNamespace:P.CHAIN.EVM}),await a.swapTokens(),await a.getTransaction(),e.approvalTransaction=void 0,e.loadingApprovalTransaction=!1}catch(d){const c=d;e.transactionError=c==null?void 0:c.displayMessage,e.loadingApprovalTransaction=!1,g.showError((c==null?void 0:c.displayMessage)||"Transaction error"),B.sendEvent({type:"track",event:"SWAP_APPROVAL_ERROR",properties:{message:(c==null?void 0:c.displayMessage)||(c==null?void 0:c.message)||"Unknown",network:((r=w.state.activeCaipNetwork)==null?void 0:r.caipNetworkId)||"",swapFromToken:((i=a.state.sourceToken)==null?void 0:i.symbol)||"",swapToToken:((u=a.state.toToken)==null?void 0:u.symbol)||"",swapFromAmount:a.state.sourceTokenAmount||"",swapToAmount:a.state.toTokenAmount||"",isSmartAccount:M(P.CHAIN.EVM)===F.ACCOUNT_TYPES.SMART_ACCOUNT}})}},async sendTransactionForSwap(n){var u,d,c,T,p,f,S,h,y,b,C,W;if(!n)return;const{fromAddress:t,toTokenAmount:o,isAuthConnector:s}=a.getParams();e.loadingTransaction=!0;const r=`Swapping ${(u=e.sourceToken)==null?void 0:u.symbol} to ${l.formatNumberToLocalString(o,3)} ${(d=e.toToken)==null?void 0:d.symbol}`,i=`Swapped ${(c=e.sourceToken)==null?void 0:c.symbol} to ${l.formatNumberToLocalString(o,3)} ${(T=e.toToken)==null?void 0:T.symbol}`;s?A.pushTransactionStack({onSuccess(){A.replace("Account"),g.showLoading(r),E.resetState()}}):g.showLoading("Confirm transaction in your wallet");try{const U=[(p=e.sourceToken)==null?void 0:p.address,(f=e.toToken)==null?void 0:f.address].join(","),m=await D.sendTransaction({address:t,to:n.to,data:n.data,value:n.value,chainNamespace:P.CHAIN.EVM});return e.loadingTransaction=!1,g.showSuccess(i),B.sendEvent({type:"track",event:"SWAP_SUCCESS",properties:{network:((S=w.state.activeCaipNetwork)==null?void 0:S.caipNetworkId)||"",swapFromToken:((h=a.state.sourceToken)==null?void 0:h.symbol)||"",swapToToken:((y=a.state.toToken)==null?void 0:y.symbol)||"",swapFromAmount:a.state.sourceTokenAmount||"",swapToAmount:a.state.toTokenAmount||"",isSmartAccount:M(P.CHAIN.EVM)===F.ACCOUNT_TYPES.SMART_ACCOUNT}}),E.resetState(),s||A.replace("Account"),E.getMyTokensWithBalance(U),m}catch(U){const m=U;e.transactionError=m==null?void 0:m.displayMessage,e.loadingTransaction=!1,g.showError((m==null?void 0:m.displayMessage)||"Transaction error"),B.sendEvent({type:"track",event:"SWAP_ERROR",properties:{message:(m==null?void 0:m.displayMessage)||(m==null?void 0:m.message)||"Unknown",network:((b=w.state.activeCaipNetwork)==null?void 0:b.caipNetworkId)||"",swapFromToken:((C=a.state.sourceToken)==null?void 0:C.symbol)||"",swapToToken:((W=a.state.toToken)==null?void 0:W.symbol)||"",swapFromAmount:a.state.sourceTokenAmount||"",swapToAmount:a.state.toTokenAmount||"",isSmartAccount:M(P.CHAIN.EVM)===F.ACCOUNT_TYPES.SMART_ACCOUNT}});return}},hasInsufficientToken(n,t){return I.isInsufficientSourceTokenForSwap(n,t,e.myTokensWithBalance)},setTransactionDetails(){const{toTokenAddress:n,toTokenDecimals:t}=a.getParams();!n||!t||(e.gasPriceInUSD=I.getGasPriceInUSD(e.networkPrice,BigInt(e.gasFee),BigInt(_)),e.priceImpact=I.getPriceImpact({sourceTokenAmount:e.sourceTokenAmount,sourceTokenPriceInUSD:e.sourceTokenPriceInUSD,toTokenPriceInUSD:e.toTokenPriceInUSD,toTokenAmount:e.toTokenAmount}),e.maxSlippage=I.getMaxSlippage(e.slippage,e.toTokenAmount),e.providerFee=I.getProviderFee(e.sourceTokenAmount))}},a=G(E);export{a as S};
