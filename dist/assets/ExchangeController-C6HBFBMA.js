import{g as U,h as x,i as l,E,j as A,S as P,k as N,l as f,m as I,n as L,O as y,N as C,o as b,r as v,s as T,v as W,w as _}from"./index-Bxd8aEoY.js";const D=0,S={paymentAsset:null,amount:null,tokenAmount:0,priceLoading:!1,error:null,exchanges:[],isLoading:!1,currentPayment:void 0,isPaymentInProgress:!1,paymentId:"",assets:[]},e=U(S),m={state:e,subscribe(s){return _(e,()=>s(e))},subscribeKey(s,t){return W(e,s,t)},resetState(){Object.assign(e,{...S})},async getAssetsForNetwork(s){const t=T(s),n=await m.getAssetsImageAndPrice(t),r=t.map(a=>{var c,o,p,g;const u=a.asset==="native"?b():`${a.network}:${a.asset}`,i=n.find(k=>{var d,h,w;return((w=(h=(d=k.fungibles)==null?void 0:d[0])==null?void 0:h.address)==null?void 0:w.toLowerCase())===u.toLowerCase()});return{...a,price:((o=(c=i==null?void 0:i.fungibles)==null?void 0:c[0])==null?void 0:o.price)||1,metadata:{...a.metadata,iconUrl:(g=(p=i==null?void 0:i.fungibles)==null?void 0:p[0])==null?void 0:g.iconUrl}}});return e.assets=r,r},async getAssetsImageAndPrice(s){const t=s.map(r=>r.asset==="native"?b():`${r.network}:${r.asset}`);return await Promise.all(t.map(r=>v.fetchTokenPrice({addresses:[r]})))},getTokenAmount(){var n;if(!((n=e==null?void 0:e.paymentAsset)!=null&&n.price))throw new Error("Cannot get token price");const s=C.bigNumber(e.amount??0).round(8),t=C.bigNumber(e.paymentAsset.price).round(8);return s.div(t).round(8).toNumber()},setAmount(s){var t;e.amount=s,(t=e.paymentAsset)!=null&&t.price&&(e.tokenAmount=m.getTokenAmount())},setPaymentAsset(s){e.paymentAsset=s},isPayWithExchangeEnabled(){var s,t,n;return((s=y.state.remoteFeatures)==null?void 0:s.payWithExchange)||((t=y.state.remoteFeatures)==null?void 0:t.payments)||((n=y.state.features)==null?void 0:n.pay)},isPayWithExchangeSupported(){return m.isPayWithExchangeEnabled()&&l.state.activeCaipNetwork&&L.PAY_WITH_EXCHANGE_SUPPORTED_CHAIN_NAMESPACES.includes(l.state.activeCaipNetwork.chainNamespace)},async fetchExchanges(){var s;try{const t=m.isPayWithExchangeSupported();if(!e.paymentAsset||!t){e.exchanges=[],e.isLoading=!1;return}e.isLoading=!0;const n=await I({page:D,asset:f(e.paymentAsset.network,e.paymentAsset.asset),amount:((s=e.amount)==null?void 0:s.toString())??"0"});e.exchanges=n.exchanges.slice(0,2)}catch{throw P.showError("Unable to get exchanges"),new Error("Unable to get exchanges")}finally{e.isLoading=!1}},async getPayUrl(s,t){try{const n=Number(t.amount),r=await N({exchangeId:s,asset:f(t.network,t.asset),amount:n.toString(),recipient:`${t.network}:${t.recipient}`});return E.sendEvent({type:"track",event:"PAY_EXCHANGE_SELECTED",properties:{exchange:{id:s},configuration:{network:t.network,asset:t.asset,recipient:t.recipient,amount:n},currentPayment:{type:"exchange",exchangeId:s},source:"fund-from-exchange",headless:!1}}),r}catch(n){throw n instanceof Error&&n.message.includes("is not supported")?new Error("Asset not supported"):new Error(n.message)}},async handlePayWithExchange(s){var t;try{const n=(t=l.getAccountData())==null?void 0:t.address;if(!n)throw new Error("No account connected");if(!e.paymentAsset)throw new Error("No payment asset selected");const r=A.returnOpenHref("","popupWindow","scrollbar=yes,width=480,height=720");if(!r)throw new Error("Could not create popup window");e.isPaymentInProgress=!0,e.paymentId=crypto.randomUUID(),e.currentPayment={type:"exchange",exchangeId:s};const{network:a,asset:u}=e.paymentAsset,i={network:a,asset:u,amount:e.tokenAmount,recipient:n},c=await m.getPayUrl(s,i);if(!c){try{r.close()}catch(o){console.error("Unable to close popup window",o)}throw new Error("Unable to initiate payment")}e.currentPayment.sessionId=c.sessionId,e.currentPayment.status="IN_PROGRESS",e.currentPayment.exchangeId=s,r.location.href=c.url}catch{e.error="Unable to initiate payment",P.showError(e.error)}},async waitUntilComplete({exchangeId:s,sessionId:t,paymentId:n,retries:r=20}){const a=await m.getBuyStatus(s,t,n);if(a.status==="SUCCESS"||a.status==="FAILED")return a;if(r===0)throw new Error("Unable to get deposit status");return await new Promise(u=>{setTimeout(u,5e3)}),m.waitUntilComplete({exchangeId:s,sessionId:t,paymentId:n,retries:r-1})},async getBuyStatus(s,t,n){var r,a,u,i,c;try{if(!e.currentPayment)throw new Error("No current payment");const o=await x({sessionId:t,exchangeId:s});if(e.currentPayment.status=o.status,o.status==="SUCCESS"||o.status==="FAILED"){const p=(r=l.getAccountData())==null?void 0:r.address;e.currentPayment.result=o.txHash,e.isPaymentInProgress=!1,E.sendEvent({type:"track",event:o.status==="SUCCESS"?"PAY_SUCCESS":"PAY_ERROR",properties:{message:o.status==="FAILED"?A.parseError(e.error):void 0,source:"fund-from-exchange",paymentId:n,configuration:{network:((a=e.paymentAsset)==null?void 0:a.network)||"",asset:((u=e.paymentAsset)==null?void 0:u.asset)||"",recipient:p||"",amount:e.amount??0},currentPayment:{type:"exchange",exchangeId:(i=e.currentPayment)==null?void 0:i.exchangeId,sessionId:(c=e.currentPayment)==null?void 0:c.sessionId,result:o.txHash}}})}return o}catch{return{status:"UNKNOWN",txHash:""}}},reset(){e.currentPayment=void 0,e.isPaymentInProgress=!1,e.paymentId="",e.paymentAsset=null,e.amount=0,e.tokenAmount=0,e.priceLoading=!1,e.error=null,e.exchanges=[],e.isLoading=!1}};export{m as E};
