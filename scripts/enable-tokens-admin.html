<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enable Tokens (Admin) - BSC Mainnet</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.0/dist/ethers.umd.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 50px auto;
            padding: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        h1 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        .subtitle {
            text-align: center;
            margin-bottom: 30px;
            opacity: 0.9;
            font-size: 1.1em;
        }
        .button {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            padding: 18px 40px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            width: 100%;
            margin: 15px 0;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .button:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(255, 255, 255, 0.3);
        }
        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: scale(1);
        }
        .button-secondary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        .result {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
        }
        .info {
            background: rgba(59, 130, 246, 0.2);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #3b82f6;
        }
        .warning {
            background: rgba(245, 158, 11, 0.2);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #f59e0b;
        }
        .success {
            color: #4ade80;
        }
        .error {
            color: #f87171;
        }
        .admin-check {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }
        .token-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .token-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        .token-card.enabled {
            border-color: #4ade80;
        }
        .token-card.disabled {
            border-color: #f87171;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîì Enable Tokens (Admin)</h1>
        <p class="subtitle">P2PEscrowV2 Contract Configuration - BSC Mainnet</p>
        
        <div class="info">
            <strong>üìã Contract Address:</strong><br>
            <code>0x6722FE6DdCe1F7389daa70aD5C65e51f9F375E6e</code><br><br>
            <strong>üåê Network:</strong> BSC Mainnet (Chain ID: 56)<br>
            <strong>‚ö†Ô∏è Admin Only:</strong> Only contract admin can enable tokens
        </div>

        <div class="warning">
            <strong>‚ö†Ô∏è IMPORTANT:</strong><br>
            You must be the <strong>ADMIN</strong> of the contract to enable tokens!<br>
            If you're not the admin, contact the contract owner.
        </div>

        <button class="button" onclick="connectWallet()">üîó Connect Wallet</button>
        <button class="button button-secondary" onclick="checkStatus()" id="checkBtn" disabled>üîç Check Token Status</button>
        <button class="button" onclick="enableNativeBNB()" id="enableBNBBtn" disabled>üîì Enable Native BNB</button>

        <div id="result"></div>
    </div>

    <script>
        let provider;
        let signer;
        let contract;
        let userAddress;

        const CONTRACT_ADDRESS = '0x6722FE6DdCe1F7389daa70aD5C65e51f9F375E6e';
        const BSC_MAINNET_CHAIN_ID = '0x38'; // 56 in hex
        const BSC_MAINNET_CHAIN_ID_DECIMAL = 56;

        // Token addresses on BSC Mainnet
        const TOKENS = {
            USDT: '0x55d398326f99059fF775485246999027B3197955',
            USDC: '0x8AC76a51cc950d9822D68b83fE1Ad97B32Cd580d',
            BNB: '0x0000000000000000000000000000000000000000' // Native BNB
        };

        // P2PEscrowV2 ABI
        const CONTRACT_ABI = [
            "function admin() view returns (address)",
            "function allowedNative() view returns (bool)",
            "function setAllowedNative(bool _allowed)",
            "function allowedTokens(address) view returns (bool)",
            "function setAllowedToken(address token, bool allowed)",
            "event NativeAllowed(bool allowed)",
            "event TokenAllowed(address indexed token, bool allowed)"
        ];

        async function connectWallet() {
            try {
                if (!window.ethereum) {
                    showResult('‚ùå Wallet not found! Please install MetaMask or Trust Wallet.', 'error');
                    return;
                }

                showResult('üîÑ Connecting to wallet...', 'info');

                const accounts = await window.ethereum.request({ 
                    method: 'eth_requestAccounts' 
                });

                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                userAddress = accounts[0];

                // Initialize contract
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

                // Check network
                const network = await provider.getNetwork();
                const chainId = Number(network.chainId);

                let resultHTML = `
                    <div class="admin-check">
                        <h3>‚úÖ Wallet Connected!</h3>
                        <p><strong>Your Address:</strong><br><code>${userAddress}</code></p>
                        <p><strong>Network:</strong> ${network.name} (Chain ID: ${chainId})</p>
                `;

                if (chainId !== BSC_MAINNET_CHAIN_ID_DECIMAL) {
                    resultHTML += `
                        <p class="error">‚ö†Ô∏è Wrong Network! Please switch to BSC Mainnet.</p>
                        <button class="button" onclick="switchToBSCMainnet()">üîÑ Switch to BSC Mainnet</button>
                    `;
                } else {
                    resultHTML += `<p class="success">‚úÖ Correct Network (BSC Mainnet)</p>`;
                    document.getElementById('checkBtn').disabled = false;
                    
                    // Auto-check status
                    setTimeout(() => checkStatus(), 1000);
                }

                resultHTML += `</div>`;
                showResult(resultHTML, 'success');

            } catch (error) {
                showResult(`‚ùå Error connecting wallet: ${error.message}`, 'error');
            }
        }

        async function switchToBSCMainnet() {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: BSC_MAINNET_CHAIN_ID }],
                });
                showResult('‚úÖ Switched to BSC Mainnet! Reconnecting...', 'success');
                setTimeout(() => connectWallet(), 1000);
            } catch (error) {
                if (error.code === 4902) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: BSC_MAINNET_CHAIN_ID,
                                chainName: 'BSC Mainnet',
                                nativeCurrency: { name: 'BNB', symbol: 'BNB', decimals: 18 },
                                rpcUrls: ['https://bsc-dataseed.binance.org/'],
                                blockExplorerUrls: ['https://bscscan.com']
                            }]
                        });
                        setTimeout(() => connectWallet(), 1000);
                    } catch (addError) {
                        showResult(`‚ùå Error adding network: ${addError.message}`, 'error');
                    }
                } else {
                    showResult(`‚ùå Error switching network: ${error.message}`, 'error');
                }
            }
        }

        async function checkStatus() {
            try {
                showResult('üîÑ Checking contract status...', 'info');

                // Get admin address
                const adminAddress = await contract.admin();
                console.log('üîë Contract Admin:', adminAddress);

                // Get native BNB status
                const isNativeAllowed = await contract.allowedNative();
                console.log('ü™ô Native BNB Allowed:', isNativeAllowed);

                // Check token statuses
                const usdtAllowed = await contract.allowedTokens(TOKENS.USDT);
                const usdcAllowed = await contract.allowedTokens(TOKENS.USDC);
                console.log('ü™ô USDT Allowed:', usdtAllowed);
                console.log('ü™ô USDC Allowed:', usdcAllowed);

                // Check if user is admin
                const isUserAdmin = userAddress.toLowerCase() === adminAddress.toLowerCase();
                console.log('üë§ You are admin:', isUserAdmin);

                let resultHTML = `
                    <div class="admin-check">
                        <h3>üìä Contract Status</h3>
                        
                        <div style="margin: 20px 0;">
                            <p><strong>üîë Contract Admin:</strong></p>
                            <code>${adminAddress}</code>
                        </div>

                        <div style="margin: 20px 0;">
                            <p><strong>üë§ Your Address:</strong></p>
                            <code>${userAddress}</code>
                        </div>

                        <div style="margin: 20px 0; padding: 15px; background: ${isUserAdmin ? 'rgba(34, 197, 94, 0.2)' : 'rgba(239, 68, 68, 0.2)'}; border-radius: 10px;">
                            <p><strong>Admin Check:</strong></p>
                            ${isUserAdmin ? 
                                '<p class="success">‚úÖ You ARE the admin!</p>' : 
                                '<p class="error">‚ùå You are NOT the admin</p>'
                            }
                        </div>

                        <div class="token-grid">
                            <div class="token-card ${isNativeAllowed ? 'enabled' : 'disabled'}">
                                <h4>ü™ô Native BNB</h4>
                                <p><code>${TOKENS.BNB}</code></p>
                                <p><strong>Status:</strong> ${isNativeAllowed ? 
                                    '<span class="success">‚úÖ ENABLED</span>' : 
                                    '<span class="error">‚ùå DISABLED</span>'
                                }</p>
                                ${isUserAdmin && !isNativeAllowed ? 
                                    '<button class="button" onclick="enableNativeBNB()" style="margin-top: 10px;">Enable BNB</button>' : 
                                    ''
                                }
                            </div>

                            <div class="token-card ${usdtAllowed ? 'enabled' : 'disabled'}">
                                <h4>üíµ USDT</h4>
                                <p><code>${TOKENS.USDT}</code></p>
                                <p><strong>Status:</strong> ${usdtAllowed ? 
                                    '<span class="success">‚úÖ ENABLED</span>' : 
                                    '<span class="error">‚ùå DISABLED</span>'
                                }</p>
                                ${isUserAdmin && !usdtAllowed ? 
                                    '<button class="button" onclick="enableToken(\'USDT\')" style="margin-top: 10px;">Enable USDT</button>' : 
                                    ''
                                }
                            </div>

                            <div class="token-card ${usdcAllowed ? 'enabled' : 'disabled'}">
                                <h4>üíµ USDC</h4>
                                <p><code>${TOKENS.USDC}</code></p>
                                <p><strong>Status:</strong> ${usdcAllowed ? 
                                    '<span class="success">‚úÖ ENABLED</span>' : 
                                    '<span class="error">‚ùå DISABLED</span>'
                                }</p>
                                ${isUserAdmin && !usdcAllowed ? 
                                    '<button class="button" onclick="enableToken(\'USDC\')" style="margin-top: 10px;">Enable USDC</button>' : 
                                    ''
                                }
                            </div>
                        </div>
                `;

                if (!isUserAdmin) {
                    resultHTML += `
                        <div class="warning">
                            <strong>‚ö†Ô∏è Not Authorized!</strong><br>
                            You are not the admin of this contract.<br>
                            Contact the admin to enable tokens:<br>
                            <code>${adminAddress}</code>
                        </div>
                    `;
                }

                resultHTML += `</div>`;
                showResult(resultHTML, 'success');

                // Update buttons
                if (isUserAdmin) {
                    document.getElementById('enableBNBBtn').disabled = !isNativeAllowed ? false : true;
                    if (isNativeAllowed) {
                        document.getElementById('enableBNBBtn').innerText = '‚úÖ Native BNB Already Enabled';
                    }
                } else {
                    document.getElementById('enableBNBBtn').disabled = true;
                }

            } catch (error) {
                console.error('‚ùå Error checking status:', error);
                showResult(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function enableNativeBNB() {
            try {
                showResult('üîÑ Enabling Native BNB...', 'info');

                const tx = await contract.setAllowedNative(true);
                
                showResult(`
                    <div class="admin-check">
                        <h3>‚è≥ Transaction Sent!</h3>
                        <p><strong>TX Hash:</strong><br><code>${tx.hash}</code></p>
                        <p>Waiting for confirmation...</p>
                        <p><a href="https://bscscan.com/tx/${tx.hash}" target="_blank" style="color: #60a5fa;">View on BSCScan ‚Üí</a></p>
                    </div>
                `, 'info');

                const receipt = await tx.wait();
                
                showResult(`
                    <div class="admin-check">
                        <h3 class="success">‚úÖ SUCCESS!</h3>
                        <div style="margin: 20px 0; padding: 20px; background: rgba(34, 197, 94, 0.2); border-radius: 10px;">
                            <p style="font-size: 1.3em;"><strong>üéâ Native BNB is now ENABLED!</strong></p>
                        </div>
                        <p><strong>TX Hash:</strong> <code>${tx.hash}</code></p>
                        <p><a href="https://bscscan.com/tx/${tx.hash}" target="_blank" style="color: #60a5fa;">View on BSCScan ‚Üí</a></p>
                    </div>
                `, 'success');

                document.getElementById('enableBNBBtn').disabled = true;
                document.getElementById('enableBNBBtn').innerText = '‚úÖ Native BNB Enabled Successfully!';
                
                // Refresh status
                setTimeout(() => checkStatus(), 2000);

            } catch (error) {
                console.error('‚ùå Error enabling native BNB:', error);
                let errorMsg = error.message;
                if (error.code === 'ACTION_REJECTED') {
                    errorMsg = 'Transaction rejected by user';
                }
                showResult(`‚ùå Error: ${errorMsg}`, 'error');
            }
        }

        async function enableToken(tokenSymbol) {
            try {
                const tokenAddress = TOKENS[tokenSymbol];
                if (!tokenAddress) {
                    showResult(`‚ùå Invalid token: ${tokenSymbol}`, 'error');
                    return;
                }

                showResult(`üîÑ Enabling ${tokenSymbol}...`, 'info');

                const tx = await contract.setAllowedToken(tokenAddress, true);
                
                showResult(`
                    <div class="admin-check">
                        <h3>‚è≥ Transaction Sent!</h3>
                        <p><strong>Token:</strong> ${tokenSymbol}</p>
                        <p><strong>TX Hash:</strong><br><code>${tx.hash}</code></p>
                        <p>Waiting for confirmation...</p>
                        <p><a href="https://bscscan.com/tx/${tx.hash}" target="_blank" style="color: #60a5fa;">View on BSCScan ‚Üí</a></p>
                    </div>
                `, 'info');

                const receipt = await tx.wait();
                
                showResult(`
                    <div class="admin-check">
                        <h3 class="success">‚úÖ SUCCESS!</h3>
                        <div style="margin: 20px 0; padding: 20px; background: rgba(34, 197, 94, 0.2); border-radius: 10px;">
                            <p style="font-size: 1.3em;"><strong>üéâ ${tokenSymbol} is now ENABLED!</strong></p>
                        </div>
                        <p><strong>TX Hash:</strong> <code>${tx.hash}</code></p>
                        <p><a href="https://bscscan.com/tx/${tx.hash}" target="_blank" style="color: #60a5fa;">View on BSCScan ‚Üí</a></p>
                    </div>
                `, 'success');
                
                // Refresh status
                setTimeout(() => checkStatus(), 2000);

            } catch (error) {
                console.error(`‚ùå Error enabling ${tokenSymbol}:`, error);
                let errorMsg = error.message;
                if (error.code === 'ACTION_REJECTED') {
                    errorMsg = 'Transaction rejected by user';
                }
                showResult(`‚ùå Error: ${errorMsg}`, 'error');
            }
        }

        function showResult(message, type = 'info') {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = `<div class="result ${type}">${message}</div>`;
        }

        // Auto-connect if already connected
        window.addEventListener('load', async () => {
            if (window.ethereum) {
                try {
                    const accounts = await window.ethereum.request({ 
                        method: 'eth_accounts' 
                    });
                    if (accounts.length > 0) {
                        await connectWallet();
                    }
                } catch (error) {
                    console.error('Auto-connect failed:', error);
                }
            }
        });
    </script>
</body>
</html>

